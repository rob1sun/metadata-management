<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SAML metadata – välj feeds</title>

  <!-- Anti-indexering -->
  <meta name="robots" content="noindex, nofollow, noarchive" />
  <meta name="googlebot" content="noindex, nofollow, noarchive" />
  <meta http-equiv="X-Robots-Tag" content="noindex, nofollow, noarchive" />

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; line-height: 1.45; max-width: 960px; }
    h1 { font-size: clamp(1.4rem, 2vw, 1.8rem); margin: 0 0 .25rem; }
    p.muted { opacity: .8; margin-top: 0; }
    .card { border: 1px solid #8884; border-radius: 1rem; padding: 1rem; margin-top: 1rem; }
    .row { display: grid; gap: .8rem; }
    .actions { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    button { padding: .65rem 1rem; font-weight: 700; border-radius: .7rem; border: 1px solid #8884; cursor: pointer; background: transparent; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .msg { font-weight: 600; }
    .msg.ok { color: #15803d; }
    .msg.err { color: #b00020; }
    details.fed { border: 1px solid #8884; border-radius: .8rem; padding: .5rem .8rem; }
    details.fed > summary { cursor: pointer; font-weight: 700; }
    .feeds { display: grid; gap: .4rem; margin: .6rem 0 0 .6rem; }
    .feed-row { display: grid; grid-template-columns: auto 1fr; gap: .5rem .6rem; align-items: start; }
    .feed-title { font-weight: 600; }
    .feed-url { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .95rem; overflow-wrap: anywhere; opacity: .95; }
    .toolbar { display: flex; gap: .6rem; align-items: center; flex-wrap: wrap; margin: .3rem 0 .2rem; }
    .small { font-size: .95rem; opacity: .9; }
    .hidden { display: none !important; }
    .spinner { width: 18px; height: 18px; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; vertical-align: text-bottom; }
    @keyframes spin { to { transform: rotate(360deg); } }
    ul.links { margin: .4rem 0 0; padding-left: 1.2rem; }
    h2.inline { display:inline; margin:0; font-size:1.05rem; }
  </style>
</head>
<body>
  <h1>SAML metadata – välj feeds</h1>
  <p class="muted">Markera vilka feeds som ska läsas in och klicka <em>Läs in valda</em>. Du får en bekräftelse direkt när jobbet startar.</p>

  <section class="card">
    <div class="row">
      <div class="toolbar">
        <h2 class="inline">Välj metadata feeds</h2>
        <span id="loading" class="small"><span class="spinner"></span> Hämtar lista…</span>
        <span id="loadError" class="msg err hidden"></span>
      </div>
      <div id="feedsContainer" class="row"></div>

      <div class="actions">
        <button id="selectAllBtn" type="button">Markera alla</button>
        <button id="clearAllBtn" type="button">Avmarkera alla</button>
        <button id="ingestBtn" type="button">Läs in valda</button>
        <span id="msg" class="msg" role="status" aria-live="polite"></span>
      </div>

      <div class="small">
        Backend förväntar sig <code>POST /ingest</code> med JSON:
        <code>{"urls":[...]}</code>.
      </div>
    </div>
  </section>

  <section class="card">
    <strong>Publicerade endpoints (om du använder samma worker-backend):</strong>
    <ul class="links">
      <li><a href="/metadata.xml" target="_blank" rel="noopener">/metadata.xml</a> – senaste manipulerade metadata</li>
      <li><a href="/status" target="_blank" rel="noopener">/status</a> – status/metadata</li>
    </ul>
  </section>

  <script>
    (function () {
      const FEEDS_URL = 'https://metadata-management.pages.dev/federation_feeds/';

      const feedsContainer = document.getElementById('feedsContainer');
      const loadingEl = document.getElementById('loading');
      const loadErrorEl = document.getElementById('loadError');
      const selectAllBtn = document.getElementById('selectAllBtn');
      const clearAllBtn  = document.getElementById('clearAllBtn');
      const ingestBtn    = document.getElementById('ingestBtn');
      const msg          = document.getElementById('msg');

      let allCheckboxes = [];

      function setMsg(text, type) {
        msg.textContent = text || '';
        msg.className = `msg ${type || ''}`;
      }
      function showError(text) {
        loadErrorEl.textContent = text;
        loadErrorEl.classList.remove('hidden');
      }
      function hideLoad() { loadingEl.classList.add('hidden'); }

      // --- Robust hämtning/parsning av JSON (tål text/html + trailing commas) ---
      async function fetchFeeds() {
        const res = await fetch(FEEDS_URL, { headers: { 'accept': 'application/json,text/plain,text/html' } });
        if (!res.ok) throw new Error(`Kunde inte hämta feed-lista (${res.status})`);
        let text = await res.text();

        // Om sidan redan är ren JSON: bra. Annars sanera (ta bort HTML-krimskrams).
        // 1) Extrahera ev. JSON om den ligger i HTML
        if (!looksLikeJson(text)) {
          const m = text.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
          if (m) text = m[0];
        }

        // 2) Sanera trailing commas (både i objekt och arrayer)
        text = stripTrailingCommas(text);

        // 3) Försök parse
        let data = JSON.parse(text);

        // Källan har nyckeln "federation feeds" (med mellanslag). Anpassa:
        if (data && !Array.isArray(data)) {
          const key = Object.keys(data).find(k => k.toLowerCase().replace(/\s+/g,'') === 'federationfeeds');
          if (key) data = data[key];
        }
        // Se till att vi har en array
        if (!Array.isArray(data)) data = [data].filter(Boolean);

        return data;
      }

      function looksLikeJson(s) {
        const t = s.trim();
        return (t.startsWith('{') && t.endsWith('}')) || (t.startsWith('[') && t.endsWith(']'));
      }

      function stripTrailingCommas(jsonText) {
        // Ta bort trailing commas i objekt: {"a":1,}
        jsonText = jsonText.replace(/,\s*}/g, '}');
        // Ta bort trailing commas i array: [1,2,]
        jsonText = jsonText.replace(/,\s*]/g, ']');
        return jsonText;
      }

      function renderFeeds(groups) {
        feedsContainer.innerHTML = '';
        allCheckboxes = [];

        if (!groups.length) {
          feedsContainer.innerHTML = '<div class="small">Inga feeds hittades.</div>';
          return;
        }

        groups.forEach((group, idx) => {
          const federation = String(group.federation || 'Okänd federation');

          // Inre feeds: fältet heter "feeds", med poster som har { feed: <namn>, url: <url> }
          const feeds = Array.isArray(group.feeds) ? group.feeds : [];

          const details = document.createElement('details');
          details.className = 'fed';
          details.open = idx < 3; // öppna några för bekvämlighet

          const sum = document.createElement('summary');
          sum.textContent = federation;
          details.appendChild(sum);

          const toolbar = document.createElement('div');
          toolbar.className = 'toolbar small';
          const markAll = document.createElement('button');
          markAll.type = 'button';
          markAll.textContent = 'Markera alla i denna';
          const clearAll = document.createElement('button');
          clearAll.type = 'button';
          clearAll.textContent = 'Avmarkera alla i denna';
          toolbar.append(markAll, clearAll);
          details.appendChild(toolbar);

          const wrap = document.createElement('div');
          wrap.className = 'feeds';

          feeds.forEach((f, i) => {
            const title = (f && (f.feed || f.name || f.title)) ? String(f.feed || f.name || f.title) : 'Okänd feed';
            const url = f && f.url ? String(f.url).trim() : '';

            if (!url) return; // hoppa över poster utan url

            const id = `cb_${idx}_${i}`;
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.id = id;
            cb.value = url;

            const row = document.createElement('div');
            row.className = 'feed-row';

            const label = document.createElement('label');
            label.htmlFor = id;
            label.innerHTML = `<span class="feed-title">${escapeHtml(title)}</span>
                               <span class="feed-url">${escapeHtml(url)}</span>`;

            row.appendChild(cb);
            row.appendChild(label);

            wrap.appendChild(row);
            allCheckboxes.push(cb);
          });

          // Gruppknappar
          markAll.addEventListener('click', () => {
            wrap.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
          });
          clearAll.addEventListener('click', () => {
            wrap.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
          });

          details.appendChild(wrap);
          feedsContainer.appendChild(details);
        });
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      async function ingestSelected() {
        setMsg('', '');
        const urls = allCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
        if (!urls.length) {
          setMsg('Välj minst en feed.', 'err');
          return;
        }
        try {
          ingestBtn.disabled = true;
          const res = await fetch('/ingest', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ urls })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || data.error) throw new Error(data.error || `Fel (${res.status})`);
          setMsg('Inläsningen har påbörjats.', 'ok');
        } catch (e) {
          setMsg(e.message || 'Ett fel uppstod vid inläsningen.', 'err');
        } finally {
          ingestBtn.disabled = false;
        }
      }

      function selectAll()  { allCheckboxes.forEach(cb => cb.checked = true); }
      function clearAll()   { allCheckboxes.forEach(cb => cb.checked = false); }

      // init
      (async () => {
        try {
          const groups = await fetchFeeds();
          hideLoad();
          renderFeeds(groups);
        } catch (e) {
          hideLoad();
          showError(e.message || 'Kunde inte ladda feedlistan.');
        }
      })();

      selectAllBtn.addEventListener('click', selectAll);
      clearAllBtn.addEventListener('click', clearAll);
      ingestBtn.addEventListener('click', ingestSelected);
    })();
  </script>
</body>
</html>
