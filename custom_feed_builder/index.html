<!doctype html>
}


function updateCounts(){
rowCount.textContent = state.filtered.length;
selCount.textContent = state.selected.size;
copyBtn.disabled = state.selected.size === 0;
buildBtn.disabled = state.selected.size === 0 || !WORKER_BASE;
selectAll.checked = state.filtered.length>0 && state.filtered.every(it=>state.selected.has(it.entityID||''));
}


function copySelected(){
const ids = [...state.selected];
navigator.clipboard.writeText(JSON.stringify(ids, null, 2)).then(()=>{
copyBtn.textContent = 'Kopierat!';
setTimeout(()=>copyBtn.textContent='Kopiera valda IDs', 1200);
});
}


async function buildXml(){
if(!WORKER_BASE){ alert('S채tt WORKER_BASE i filen.'); return; }
try{
const payload = { entityIDs: [...state.selected] };
const res = await fetch(WORKER_BASE + '/build', {
method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
});
if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
const xml = await res.text();
xmlOut.value = xml;
resultPanel.style.display = '';
publishInfo.innerHTML = `Publicerat fr책n Worker-endpointen <span class="mono">/build</span>.`;
}catch(err){
alert('Kunde inte bygga/publicera XML: ' + err.message);
}
}


function downloadXml(){
const blob = new Blob([xmlOut.value||''], { type: 'application/samlmetadata+xml' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a'); a.href = url; a.download = 'metadata_filtered.xml'; a.click();
setTimeout(()=>URL.revokeObjectURL(url), 2000);
}


function copyXml(){
navigator.clipboard.writeText(xmlOut.value||'');
copyXmlBtn.textContent='Kopierat!';
setTimeout(()=>copyXmlBtn.textContent='Kopiera XML', 1200);
}


// Sm책hj채lp
function escapeHtml(s){
return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}


// === Wiring ===
reloadBtn.addEventListener('click', loadJson);
feedFilter.addEventListener('change', applyFilter);
searchBox.addEventListener('input', applyFilter);
selectAll.addEventListener('change', ()=>{
if(selectAll.checked){ state.filtered.forEach(it=>state.selected.add(it.entityID||'')); }
else { state.filtered.forEach(it=>state.selected.delete(it.entityID||'')); }
renderTable();
});
copyBtn.addEventListener('click', copySelected);
buildBtn.addEventListener('click', buildXml);
dlBtn.addEventListener('click', downloadXml);
copyXmlBtn.addEventListener('click', copyXml);


// Init
loadJson();
</script>
</body>
</html>
